---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { posts } from '../../data/posts';
import { marked } from 'marked';

export function getStaticPaths() {
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

const displayDate = new Date(post.date).toLocaleDateString('en-AU', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const seriesLabel = post.series === '2023' ? 'Original Series (2023)' : `${post.series} Update`;
const htmlContent = await marked.parse(post.content);

// JSON-LD structured data
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.title,
  datePublished: post.date,
  author: {
    '@type': 'Person',
    name: 'Leon Furze',
    url: 'https://leonfurze.com',
  },
  description: post.excerpt,
  publisher: {
    '@type': 'Person',
    name: 'Leon Furze',
  },
};
---

<BaseLayout
  title={post.title}
  description={post.excerpt}
  ogType="article"
>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <article class="article">
    {post.coverImage && (
      <div class="article-cover">
        <img src={post.coverImage} alt={`Cover image for ${post.title}`} class="article-cover-img" loading="eager" width="1920" height="1280" />
        <div class="article-cover-overlay"></div>
      </div>
    )}

    <header class="article-header container">
      <div class="article-meta">
        <span class="article-series">{seriesLabel}</span>
        <time datetime={post.date}>{displayDate}</time>
      </div>
      <h1>{post.title}</h1>
      <p class="article-excerpt">{post.excerpt}</p>
      <div class="article-tags">
        {post.categories.map(cat => (
          <span class="tag">{cat}</span>
        ))}
      </div>
      {post.coverCredit && (
        <p class="article-cover-credit">Image: {post.coverCredit}</p>
      )}
    </header>

    <hr class="divider container" />

    <div class="article-body container">
      <div class="prose" set:html={htmlContent} />
    </div>

    <hr class="divider container" />

    <footer class="article-footer container">
      <p class="license">This article is released under a <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> license.</p>
      <a href="/articles" class="back-link">&larr; All articles</a>
    </footer>
  </article>
</BaseLayout>

<style>
  .article-cover {
    position: relative;
    width: 100%;
    max-height: 420px;
    overflow: hidden;
  }

  .article-cover-img {
    width: 100%;
    height: 420px;
    object-fit: cover;
    object-position: center;
    display: block;
    opacity: 0;
    animation: fadeInUp 0.7s var(--ease-out) 0.05s forwards;
  }

  .article-cover-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      transparent 0%,
      transparent 40%,
      var(--bg) 100%
    );
    pointer-events: none;
  }

  .article-header {
    max-width: var(--content-width);
    padding-top: var(--space-lg);
    opacity: 0;
    animation: fadeInUp 0.7s var(--ease-out) 0.1s forwards;
  }

  .article-cover + .article-header {
    padding-top: var(--space-sm);
    margin-top: calc(-1 * var(--space-lg));
    position: relative;
    z-index: 1;
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: var(--space-sm);
  }

  .article-series {
    color: var(--accent);
    font-weight: 600;
  }

  .article-series::after {
    content: '\00b7';
    margin-left: var(--space-xs);
    color: var(--text-muted);
  }

  .article-header h1 {
    font-size: clamp(2rem, 5vw, 3rem);
    margin-bottom: var(--space-sm);
    font-style: italic;
  }

  .article-excerpt {
    font-size: 1.125rem;
    color: var(--text-muted);
    line-height: 1.7;
    margin-bottom: var(--space-sm);
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .tag {
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.2rem 0.5rem;
    border-radius: 100px;
    background: var(--tag-bg);
    color: var(--accent-hover);
    font-weight: 500;
  }

  .article-cover-credit {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: var(--space-sm);
    font-style: italic;
    margin-bottom: 0;
  }

  /* Prose */
  .article-body {
    max-width: var(--content-width);
    padding-top: var(--space-md);
    padding-bottom: var(--space-md);
    opacity: 0;
    animation: fadeInUp 0.7s var(--ease-out) 0.3s forwards;
  }

  .prose {
    font-size: 1.0625rem;
    line-height: 1.75;
    color: var(--prose-text);
  }

  .prose :global(h2) {
    font-family: var(--font-display);
    font-size: clamp(1.5rem, 3vw, 2rem);
    margin-top: var(--space-lg);
    margin-bottom: var(--space-sm);
    color: var(--text);
    padding-top: var(--space-xs);
    font-style: italic;
  }

  .prose :global(h3) {
    font-family: var(--font-display);
    font-size: 1.25rem;
    margin-top: var(--space-md);
    margin-bottom: var(--space-xs);
    color: var(--text);
    font-style: italic;
  }

  .prose :global(h4) {
    font-family: var(--font-display);
    font-size: 1.0625rem;
    margin-top: var(--space-md);
    margin-bottom: var(--space-xs);
    color: var(--text);
  }

  .prose :global(p) {
    margin-bottom: 1.25em;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: 1.25em;
    padding-left: 1.5em;
  }

  .prose :global(li) {
    margin-bottom: 0.5em;
  }

  .prose :global(li strong) {
    color: var(--accent-hover);
  }

  /* Enhanced blockquote */
  .prose :global(blockquote) {
    border-left: 4px solid var(--accent);
    padding: var(--space-md) var(--space-md);
    margin: var(--space-lg) 0;
    color: var(--text);
    font-style: italic;
    font-size: 1.1875rem;
    line-height: 1.65;
    background: var(--blockquote-bg);
    border-radius: 0 8px 8px 0;
    position: relative;
  }

  .prose :global(blockquote p) {
    margin-bottom: 0;
  }

  .prose :global(blockquote p:not(:last-child)) {
    margin-bottom: 0.75em;
  }

  .prose :global(em) {
    font-style: italic;
  }

  .prose :global(a) {
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-color: rgba(45, 212, 168, 0.3);
    transition: text-decoration-color var(--transition-fast), color var(--transition-fast);
  }

  .prose :global(a:hover) {
    text-decoration-color: var(--accent);
    color: var(--accent-hover);
  }

  /* Elegant horizontal rules */
  .prose :global(hr) {
    border: none;
    height: 1px;
    margin: var(--space-lg) auto;
    background: transparent;
    position: relative;
    max-width: 200px;
  }

  .prose :global(hr)::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(45, 212, 168, 0.4),
      transparent
    );
  }

  /* Footer */
  .article-footer {
    max-width: var(--content-width);
    padding-top: var(--space-sm);
    padding-bottom: var(--space-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .license {
    font-size: 0.8125rem;
    color: var(--text-muted);
    margin-bottom: 0;
  }

  .license a {
    color: var(--text-muted);
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color var(--transition-fast);
  }

  .license a:hover {
    color: var(--accent);
  }

  .back-link {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-muted);
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--accent);
  }
</style>
